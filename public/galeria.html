<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Galeria de Teste ‚Äî Forjados</title>
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:20px}
  h1{margin-bottom:10px}
  #buttons{margin-bottom:20px}
  button{margin-right:10px;padding:10px 16px;border:none;border-radius:8px;background:#222;color:#fff;cursor:pointer}
  button:hover{background:#444}
  #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
  #gallery img{width:100%;border-radius:8px;object-fit:cover;cursor:pointer;transition:transform .2s}
  #gallery img:hover{transform:scale(1.04)}
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:1000}
  #modal img{max-width:90%;max-height:90%;border-radius:10px}
  #loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-weight:bold;position:fixed;inset:0;z-index:2000}
  #cameraContainer{display:none;flex-direction:column;align-items:center;margin-bottom:20px}
  video{width:320px;border-radius:10px;margin-bottom:10px}
  #status{margin-top:10px;color:#333;font-weight:bold}
</style>
</head>
<body>
  <div id="loading-container">Carregando modelos faciais...<div style="width:60%;height:10px;background:#333;border-radius:5px;margin-top:10px"><div id="loading-progress" style="height:10px;background:deepskyblue;width:0%"></div></div></div>

  <h1>Galeria de Teste ‚Äî Forjados</h1>
  <div id="buttons">
    <button id="btnSelfie">üì∏ Tirar selfie</button>
    <button id="btnUpload">üñºÔ∏è Enviar imagem</button>
    <button id="btnMostrarTodas">üîÅ Mostrar todas</button>
  </div>

  <div id="cameraContainer">
    <video id="video" autoplay muted></video>
    <div>
      <button id="btnCapturar">üì∑ Capturar</button>
      <button id="btnCancelarCamera" style="background:#555">‚úñ Cancelar</button>
    </div>
  </div>

  <div id="status" aria-live="polite"></div>
  <div id="gallery"></div>
  <div id="modal"><img id="modalImg" src="" alt=""></div>
  <input type="file" id="fileInput" accept="image/*" style="display:none">

  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
  (async ()=> {

    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const fileInput = document.getElementById('fileInput');
    const btnSelfie = document.getElementById('btnSelfie');
    const btnUpload = document.getElementById('btnUpload');
    const btnMostrarTodas = document.getElementById('btnMostrarTodas');
    const cameraContainer = document.getElementById('cameraContainer');
    const video = document.getElementById('video');
    const btnCapturar = document.getElementById('btnCapturar');
    const btnCancelarCamera = document.getElementById('btnCancelarCamera');
    const loadingContainer = document.getElementById('loading-container');
    const loadingProgress = document.getElementById('loading-progress');
    const statusEl = document.getElementById('status');

    let allImages = [];
    let modelsLoaded = false;

    function logStatus(msg){
      console.log(msg);
      statusEl.textContent = msg;
    }

    // Carrega modelos com feedback
    async function carregarModelos(){
      try {
        const MODEL_URL = './models';
        const models = [
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ];
        let i=0;
        const upd = ()=>{ i++; loadingProgress.style.width = `${(i/models.length)*100}%`; };
        for(const m of models){ await m; upd(); console.log('modelo carregado'); }
        modelsLoaded = true;
        loadingContainer.style.display='none';
        logStatus('Modelos carregados.');
      } catch(err){
        console.error('Erro ao carregar modelos:', err);
        alert('Erro ao carregar modelos. Verifique se a pasta /models est√° presente no deploy e acess√≠vel.');
      }
    }

    // Carregar fotos e montar galeria
    async function carregarFotos(){
      try{
        const r = await fetch('./fotos.json');
        const lista = await r.json();
        montarGaleria(lista);
        console.log('fotos.json carregado:', lista.length, 'itens');
      }catch(err){
        console.error('Falha ao carregar fotos.json:', err);
        alert('Erro ao carregar fotos.json (verifique caminho/perm. e se o arquivo existe no deploy).');
      }
    }

    function montarGaleria(lista){
      gallery.innerHTML='';
      lista.forEach(item=>{
        const img = document.createElement('img');
        const thumb = item.thumb.startsWith('/') ? item.thumb : `/${item.thumb}`;
        const src = item.src.startsWith('/') ? item.src : `/${item.src}`;
        img.src = thumb;
        img.dataset.full = src;
        img.alt = item.alt || '';
        img.addEventListener('click', ()=> abrirModal(img.dataset.full));
        gallery.appendChild(img);
      });
      allImages = [...gallery.querySelectorAll('img')];
      console.log('Galeria montada com', allImages.length, 'imagens');
    }

    function abrirModal(src){ modalImg.src = src; modal.style.display='flex'; }
    modal.addEventListener('click', ()=> modal.style.display='none');

    // Fun√ß√£o de debug e processamento
    async function processarSelfie(img){
      if(!modelsLoaded){ alert('Modelos ainda n√£o carregados. Aguarde...'); return; }
      try {
        logStatus('Processando imagem...');
        console.log('Image natural size:', img.naturalWidth, img.naturalHeight, 'video size fallback', video.videoWidth, video.videoHeight);

        // op√ß√µes mais sens√≠veis para tiny detector
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.35 });

        const det = await faceapi.detectSingleFace(img, options).withFaceLandmarks(true).withFaceDescriptor();
        console.log('det:', det);
        if(!det){ alert('Nenhum rosto detectado! (verifique ilumina√ß√£o/√¢ngulo)'); logStatus('Nenhum rosto detectado'); return; }

        // informa descriptor length
        console.log('Descriptor length:', det.descriptor.length);
        logStatus('Rosto detectado. Comparando com galeria...');

        const limite = 0.55; // ajuste fino
        const resultados = [];

        for(const imagem of allImages){
          try {
            const imgEl = await faceapi.fetchImage(imagem.dataset.full);
            console.log('Processando imagem da galeria, size:', imgEl.naturalWidth, imgEl.naturalHeight, imagem.dataset.full);
            const det2 = await faceapi.detectSingleFace(imgEl, options).withFaceLandmarks(true).withFaceDescriptor();
            console.log('det2 for', imagem.dataset.full, det2 && true);
            if(det2){
              const dist = faceapi.euclideanDistance(det.descriptor, det2.descriptor);
              console.log('dist to', imagem.dataset.full, dist);
              if(dist < limite) resultados.push({el:imagem, dist});
            }
          } catch(innerErr){
            console.warn('Erro processando imagem da galeria:', imagem.dataset.full, innerErr);
          }
        }

        // ordena por dist√¢ncia (menor = mais parecido)
        resultados.sort((a,b)=>a.dist - b.dist);

        if(resultados.length){
          gallery.innerHTML='';
          resultados.forEach(r => gallery.appendChild(r.el));
          logStatus(`Encontrado(s) ${resultados.length} correspond√™ncia(s).`);
        } else {
          alert('Nenhuma correspond√™ncia encontrada.');
          logStatus('Nenhuma correspond√™ncia encontrada.');
        }
      } catch(err){
        console.error('Erro no processamento da selfie:', err);
        alert('Erro durante a detec√ß√£o (veja console).');
      }
    }

    // Upload de arquivo: cria <img> via URL.createObjectURL
    btnUpload.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file) return;
      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = async ()=>{
        console.log('Upload image loaded:', img.naturalWidth, img.naturalHeight);
        await processarSelfie(img);
        URL.revokeObjectURL(img.src);
      };
      img.onerror = ()=> alert('Erro ao carregar imagem do arquivo.');
    });

    // C√¢mera
    let currentStream = null;
    btnSelfie.addEventListener('click', async ()=>{
      try {
        cameraContainer.style.display='flex';
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false });
        currentStream = stream;
        video.srcObject = stream;
      } catch(err){
        console.error('Erro ao abrir c√¢mera:', err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera.');
      }
    });

    btnCancelarCamera.addEventListener('click', ()=>{
      cameraContainer.style.display='none';
      if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
    });

    btnCapturar.addEventListener('click', async ()=>{
      if(!video.videoWidth || !video.videoHeight){ alert('Aguardando c√¢mera...'); return; }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      const img = new Image();
      img.src = canvas.toDataURL('image/png');
      img.onload = async ()=>{
        await processarSelfie(img);
        cameraContainer.style.display='none';
        if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
      };
      img.onerror = ()=> alert('Erro ao processar captura da c√¢mera.');
    });

    btnMostrarTodas.addEventListener('click', carregarFotos);

    // inicializa√ß√£o
    await carregarModelos();
    await carregarFotos();
    logStatus('Pronto');
    console.log('Inicializa√ß√£o completa. Inspecione console para logs detalhados.');
  })();
  </script>
</body>
</html>
