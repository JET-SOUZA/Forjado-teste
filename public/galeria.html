<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Galeria de Teste ‚Äî Forjados</title>
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:20px}
  h1{margin-bottom:10px}
  #buttons{margin-bottom:20px}
  button{margin-right:10px;padding:10px 16px;border:none;border-radius:8px;background:#222;color:#fff;cursor:pointer}
  button:hover{background:#444}
  #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
  #gallery img{width:100%;border-radius:8px;object-fit:cover;cursor:pointer;transition:transform .2s}
  #gallery img:hover{transform:scale(1.04)}
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:1000}
  #modal img{max-width:90%;max-height:90%;border-radius:10px}
  #loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-weight:bold;position:fixed;inset:0;z-index:2000}
  #cameraContainer{display:none;flex-direction:column;align-items:center;margin-bottom:20px}
  video{width:320px;border-radius:10px;margin-bottom:10px}
  #status{margin-top:10px;color:#333;font-weight:bold}
</style>

<!-- ‚ö° face-api.js deve vir antes de tudo, sem defer -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

</head>
<body>
  <div id="loading-container">Carregando modelos faciais...
    <div style="width:60%;height:10px;background:#333;border-radius:5px;margin-top:10px">
      <div id="loading-progress" style="height:10px;background:deepskyblue;width:0%"></div>
    </div>
  </div>

  <h1>Galeria de Teste ‚Äî Forjados</h1>
  <div id="buttons">
    <button id="btnSelfie">üì∏ Tirar selfie</button>
    <button id="btnUpload">üñºÔ∏è Enviar imagem</button>
    <button id="btnMostrarTodas">üîÅ Mostrar todas</button>
  </div>

  <div id="cameraContainer">
    <video id="video" autoplay muted></video>
    <div>
      <button id="btnCapturar">üì∑ Capturar</button>
      <button id="btnCancelarCamera" style="background:#555">‚úñ Cancelar</button>
    </div>
  </div>

  <div id="status" aria-live="polite"></div>
  <div id="gallery"></div>
  <div id="modal"><img id="modalImg" src="" alt=""></div>
  <input type="file" id="fileInput" accept="image/*" style="display:none">

  <script>
  (async ()=> {
    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const fileInput = document.getElementById('fileInput');
    const btnSelfie = document.getElementById('btnSelfie');
    const btnUpload = document.getElementById('btnUpload');
    const btnMostrarTodas = document.getElementById('btnMostrarTodas');
    const cameraContainer = document.getElementById('cameraContainer');
    const video = document.getElementById('video');
    const btnCapturar = document.getElementById('btnCapturar');
    const btnCancelarCamera = document.getElementById('btnCancelarCamera');
    const loadingContainer = document.getElementById('loading-container');
    const loadingProgress = document.getElementById('loading-progress');
    const statusEl = document.getElementById('status');

    let allImages = [];
    let modelsLoaded = false;
    let currentStream = null;

    function logStatus(msg){
      console.log(msg);
      statusEl.textContent = msg;
    }

    // üîπ Carrega modelos faciais
    async function carregarModelos(){
      try {
        const MODEL_URL = '/models';
        const testReq = await fetch(`${MODEL_URL}/tiny_face_detector_model-weights_manifest.json`);
        if (!testReq.ok) throw new Error('Pasta /models n√£o acess√≠vel.');
        
        const modelos = [
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ];
        let i = 0;
        for (const m of modelos){
          await m; i++;
          loadingProgress.style.width = `${(i/modelos.length)*100}%`;
        }
        modelsLoaded = true;
        loadingContainer.style.display='none';
        logStatus('Modelos carregados com sucesso.');
      } catch(err){
        console.error('Erro ao carregar modelos:', err);
        alert('‚ùå Erro: n√£o foi poss√≠vel carregar os modelos. Verifique se /models est√° no deploy e p√∫blico.');
      }
    }

    // üîπ Carrega e monta galeria
    async function carregarFotos(){
      try {
        const r = await fetch('/fotos.json');
        if (!r.ok) throw new Error('fotos.json n√£o encontrado');
        const lista = await r.json();
        montarGaleria(lista);
        console.log('fotos.json carregado:', lista.length, 'itens');
      } catch(err){
        console.error('Falha ao carregar fotos.json:', err);
        alert('‚ùå Erro ao carregar fotos.json. Verifique se o arquivo existe em /public.');
      }
    }

    function montarGaleria(lista){
      gallery.innerHTML='';
      lista.forEach(item=>{
        const nome = item.arquivo || item.src || item.thumb;
        if (!nome) return;
        const src = nome.startsWith('/') ? nome : `/fotos/${nome}`;
        const img = document.createElement('img');
        img.src = src;
        img.alt = item.alt || '';
        img.dataset.full = src;
        img.addEventListener('click', ()=> abrirModal(src));
        gallery.appendChild(img);
      });
      allImages = [...gallery.querySelectorAll('img')];
      console.log('Galeria montada com', allImages.length, 'imagens');
    }

    function abrirModal(src){ modalImg.src = src; modal.style.display='flex'; }
    modal.addEventListener('click', ()=> modal.style.display='none');

    // üîπ Processa selfie ou upload
    async function processarSelfie(img){
      if(!modelsLoaded){ alert('Aguarde o carregamento dos modelos.'); return; }
      try {
        logStatus('Processando imagem...');
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.4 });
        const det = await faceapi.detectSingleFace(img, options).withFaceLandmarks(true).withFaceDescriptor();
        if(!det){ alert('Nenhum rosto detectado!'); return; }

        const limite = 0.55;
        const resultados = [];

        for(const imagem of allImages){
          try {
            const imgEl = await faceapi.fetchImage(imagem.dataset.full);
            const det2 = await faceapi.detectSingleFace(imgEl, options).withFaceLandmarks(true).withFaceDescriptor();
            if(det2){
              const dist = faceapi.euclideanDistance(det.descriptor, det2.descriptor);
              if(dist < limite) resultados.push({el:imagem, dist});
            }
          } catch(innerErr){
            console.warn('Erro processando imagem:', imagem.dataset.full, innerErr);
          }
        }

        resultados.sort((a,b)=>a.dist - b.dist);
        if(resultados.length){
          gallery.innerHTML='';
          resultados.forEach(r => gallery.appendChild(r.el));
          logStatus(`Encontrado(s) ${resultados.length} rosto(s) semelhante(s).`);
        } else {
          alert('Nenhuma correspond√™ncia encontrada.');
          logStatus('Nenhuma correspond√™ncia encontrada.');
        }
      } catch(err){
        console.error('Erro ao processar selfie:', err);
        alert('Erro ao comparar rostos.');
      }
    }

    // üîπ Upload manual
    btnUpload.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file) return;
      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = async ()=>{
        await processarSelfie(img);
        URL.revokeObjectURL(img.src);
      };
    });

    // üîπ Abertura da c√¢mera
    btnSelfie.addEventListener('click', async ()=>{
      try {
        cameraContainer.style.display='flex';
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        currentStream = stream;
        video.srcObject = stream;
      } catch(err){
        console.error('Erro ao abrir c√¢mera:', err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera.');
      }
    });

    btnCancelarCamera.addEventListener('click', ()=>{
      cameraContainer.style.display='none';
      if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
    });

    btnCapturar.addEventListener('click', async ()=>{
      if(!video.videoWidth){ alert('Aguardando c√¢mera...'); return; }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      const img = new Image();
      img.src = canvas.toDataURL('image/png');
      img.onload = async ()=>{
        await processarSelfie(img);
        cameraContainer.style.display='none';
        if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
      };
    });

    btnMostrarTodas.addEventListener('click', carregarFotos);

    await carregarModelos();
    await carregarFotos();
    logStatus('‚úÖ Pronto para uso');
  })();
  </script>
</body>
</html>
