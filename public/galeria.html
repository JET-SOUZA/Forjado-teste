<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Galeria de Teste ‚Äî Forjados</title>
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:20px}
  h1{margin-bottom:10px}
  #buttons{margin-bottom:20px}
  button{margin-right:10px;padding:10px 16px;border:none;border-radius:8px;background:#222;color:#fff;cursor:pointer}
  button:hover{background:#444}
  #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
  #gallery img{width:100%;border-radius:8px;object-fit:cover;cursor:pointer;transition:transform .2s}
  #gallery img:hover{transform:scale(1.04)}
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:1000}
  #modal img{max-width:90%;max-height:90%;border-radius:10px}
  #loading-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-weight:bold;position:fixed;inset:0;z-index:2000}
  #cameraContainer{display:none;flex-direction:column;align-items:center;margin-bottom:20px}
  video{width:320px;border-radius:10px;margin-bottom:10px}
  #status{margin-top:10px;color:#333;font-weight:bold}
</style>

<!-- ‚úÖ Biblioteca face-api.js -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
  <div id="loading-container">
    Carregando modelos faciais...
    <div style="width:60%;height:10px;background:#333;border-radius:5px;margin-top:10px">
      <div id="loading-progress" style="height:10px;background:deepskyblue;width:0%"></div>
    </div>
  </div>

  <h1>Galeria de Teste ‚Äî Forjados</h1>
  <div id="buttons">
    <button id="btnSelfie">üì∏ Tirar selfie</button>
    <button id="btnUpload">üñºÔ∏è Enviar imagem</button>
    <button id="btnMostrarTodas">üîÅ Mostrar todas</button>
  </div>

  <div id="cameraContainer">
    <video id="video" autoplay muted></video>
    <div>
      <button id="btnCapturar">üì∑ Capturar</button>
      <button id="btnCancelarCamera" style="background:#555">‚úñ Cancelar</button>
    </div>
  </div>

  <div id="status" aria-live="polite"></div>
  <div id="gallery"></div>
  <div id="modal"><img id="modalImg" src="" alt=""></div>
  <input type="file" id="fileInput" accept="image/*" style="display:none">

  <script>
  (async () => {
    const gallery = document.getElementById('gallery');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const fileInput = document.getElementById('fileInput');
    const btnSelfie = document.getElementById('btnSelfie');
    const btnUpload = document.getElementById('btnUpload');
    const btnMostrarTodas = document.getElementById('btnMostrarTodas');
    const cameraContainer = document.getElementById('cameraContainer');
    const video = document.getElementById('video');
    const btnCapturar = document.getElementById('btnCapturar');
    const btnCancelarCamera = document.getElementById('btnCancelarCamera');
    const loadingContainer = document.getElementById('loading-container');
    const loadingProgress = document.getElementById('loading-progress');
    const statusEl = document.getElementById('status');

    let allImages = [];
    let modelsLoaded = false;

    function logStatus(msg) {
      console.log(msg);
      statusEl.textContent = msg;
    }

    // Aguarda a biblioteca faceapi carregar
    function esperarFaceAPI() {
      return new Promise((resolve, reject) => {
        let tentativas = 0;
        const timer = setInterval(() => {
          if (window.faceapi) {
            clearInterval(timer);
            resolve();
          } else if (++tentativas > 50) {
            clearInterval(timer);
            reject(new Error("faceapi n√£o carregou"));
          }
        }, 200);
      });
    }

    // ‚úÖ Carrega modelos com barra de progresso
    async function carregarModelos() {
      try {
        await esperarFaceAPI();

        const total = 3;
        let carregados = 0;

        await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
        carregados++; loadingProgress.style.width = `${(carregados / total) * 100}%`;

        await faceapi.nets.faceLandmark68TinyNet.loadFromUri('/models');
        carregados++; loadingProgress.style.width = `${(carregados / total) * 100}%`;

        await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
        carregados++; loadingProgress.style.width = `${(carregados / total) * 100}%`;

        modelsLoaded = true;
        loadingContainer.style.display = 'none';
        logStatus('Modelos carregados.');
      } catch (err) {
        console.error('Erro ao carregar modelos:', err);
        alert('Erro ao carregar modelos. Verifique se a pasta /models est√° acess√≠vel.');
      }
    }

    // ‚úÖ Carrega fotos.json
    async function carregarFotos() {
      try {
        const r = await fetch('/fotos.json');
        const lista = await r.json();

        if (!Array.isArray(lista)) throw new Error("fotos.json n√£o √© uma lista v√°lida.");

        const validas = lista.filter(f => f && f.src && typeof f.src === 'string');
        if (validas.length === 0) throw new Error("Nenhuma entrada v√°lida em fotos.json.");

        montarGaleria(validas);
        console.log('fotos.json carregado:', validas.length, 'itens');
      } catch (err) {
        console.error('Falha ao carregar fotos.json:', err);
        alert('Erro ao carregar fotos.json. Verifique se o arquivo existe e cont√©m um array v√°lido.');
      }
    }

    function montarGaleria(lista) {
      gallery.innerHTML = '';
      lista.forEach(item => {
        if (!item.src) return;
        const img = document.createElement('img');
        const thumb = item.thumb?.startsWith('/') ? item.thumb : `/${item.thumb}`;
        const src = item.src.startsWith('/') ? item.src : `/${item.src}`;
        img.src = thumb;
        img.dataset.full = src;
        img.alt = item.alt || '';
        img.addEventListener('click', () => abrirModal(src));
        gallery.appendChild(img);
      });
      allImages = [...gallery.querySelectorAll('img')];
      console.log('Galeria montada com', allImages.length, 'imagens');
    }

    function abrirModal(src) {
      modalImg.src = src;
      modal.style.display = 'flex';
    }

    modal.addEventListener('click', () => modal.style.display = 'none');

    async function processarSelfie(img) {
      if (!modelsLoaded) {
        alert('Modelos ainda n√£o carregados. Aguarde...');
        return;
      }

      try {
        logStatus('Processando imagem...');
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.4 });
        const det = await faceapi.detectSingleFace(img, options).withFaceLandmarks(true).withFaceDescriptor();
        if (!det) {
          alert('Nenhum rosto detectado!');
          logStatus('Nenhum rosto detectado');
          return;
        }

        const limite = 0.55;
        const resultados = [];

        for (const imagem of allImages) {
          try {
            const imgEl = await faceapi.fetchImage(imagem.dataset.full);
            const det2 = await faceapi.detectSingleFace(imgEl, options).withFaceLandmarks(true).withFaceDescriptor();
            if (det2) {
              const dist = faceapi.euclideanDistance(det.descriptor, det2.descriptor);
              if (dist < limite) resultados.push({ el: imagem, dist });
            }
          } catch (innerErr) {
            console.warn('Erro processando imagem:', imagem.dataset.full, innerErr);
          }
        }

        resultados.sort((a, b) => a.dist - b.dist);
        if (resultados.length) {
          gallery.innerHTML = '';
          resultados.forEach(r => gallery.appendChild(r.el));
          logStatus(`Encontrado(s) ${resultados.length} correspond√™ncia(s).`);
        } else {
          alert('Nenhuma correspond√™ncia encontrada.');
          logStatus('Nenhuma correspond√™ncia encontrada.');
        }
      } catch (err) {
        console.error('Erro no processamento da selfie:', err);
        alert('Erro durante a detec√ß√£o.');
      }
    }

    // Upload manual
    btnUpload.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = async () => {
        await processarSelfie(img);
        URL.revokeObjectURL(img.src);
      };
    });

    // C√¢mera
    let currentStream = null;
    btnSelfie.addEventListener('click', async () => {
      try {
        cameraContainer.style.display = 'flex';
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        currentStream = stream;
        video.srcObject = stream;
      } catch (err) {
        console.error('Erro ao abrir c√¢mera:', err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera.');
      }
    });

    btnCancelarCamera.addEventListener('click', () => {
      cameraContainer.style.display = 'none';
      if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    });

    btnCapturar.addEventListener('click', async () => {
      if (!video.videoWidth) {
        alert('Aguardando c√¢mera...');
        return;
      }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const img = new Image();
      img.src = canvas.toDataURL('image/png');
      img.onload = async () => {
        await processarSelfie(img);
        cameraContainer.style.display = 'none';
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      };
    });

    btnMostrarTodas.addEventListener('click', carregarFotos);

    await carregarModelos();
    await carregarFotos();
    logStatus('Pronto');
  })();
  </script>
</body>
</html>
